<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fusca Pro Lookup - Auction Data Search</title>
    <link rel="icon" type="image/png" href="{{ url_for('static', filename='images/fusca-favicon.png') }}">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #f5f5f5;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            padding: 30px;
        }
        
        .header {
            display: flex;
            align-items: center;
            gap: 20px;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #3D7F4B;
        }
        
        .header-logo {
            height: 60px;
            width: auto;
        }
        
        .header-content {
            flex: 1;
            text-align: right;
        }
        
        h1 {
            color: #153D33;
            margin: 0;
            font-size: 28px;
        }
        
        .header-subtitle {
            color: #666;
            font-size: 14px;
            margin-top: 5px;
        }
        
        .search-section {
            background: #f9f9f9;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 30px;
        }
        
        .search-group {
            margin-bottom: 15px;
        }
        
        .search-bar {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        .search-bar input {
            flex: 1;
        }
        
        label {
            display: block;
            font-weight: 600;
            margin-bottom: 8px;
            color: #333;
            font-size: 14px;
        }
        
        input[type="text"], input[type="number"], select, input[type="date"] {
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            background: white;
            height: 40px;
            line-height: 1;
        }
        
        .filter-row {
            background: #fff;
            border: 1px solid #ddd;
            padding: 10px;
            margin-bottom: 8px;
            border-radius: 4px;
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        .filter-row select {
            min-width: 150px;
        }
        
        .filter-row input {
            flex: 1;
        }
        
        .remove-filter {
            background: #dc3545;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        
        .remove-filter:hover {
            background: #c82333;
        }
        
        .add-filter-btn {
            background: #17a2b8;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            margin-top: 10px;
        }
        
        .add-filter-btn:hover {
            background: #138496;
        }
        
        .filters-container {
            background: white;
            border: 1px solid #ddd;
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 20px;
        }
        
        .filters-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .filters-header h3 {
            margin: 0;
            color: #153D33;
            font-size: 16px;
        }
        
        .filter-column {
            font-weight: 600;
            color: #666;
            font-size: 13px;
            margin-right: 10px;
            min-width: 120px;
        }
        
        button {
            background: #3D7F4B;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.3s;
            height: 40px;
            line-height: 1;
        }
        
        button:hover {
            background: #153D33;
        }
        
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        
        .chart-section {
            margin-bottom: 30px;
            padding: 20px;
            background: #f9f9f9;
            border-radius: 8px;
        }
        
        .chart-container {
            position: relative;
            height: 400px;
            margin-top: 20px;
        }
        
        .results-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding: 15px;
            background: #e8f5e9;
            border-radius: 4px;
        }
        
        .results-count {
            font-weight: 600;
            color: #153D33;
            font-size: 16px;
        }
        
        .download-csv-btn {
            background: #28a745;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.3s;
        }
        
        .download-csv-btn:hover {
            background: #218838;
        }
        
        .download-csv-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        
        .saved-searches-section {
            background: #e8f5e9;
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 20px;
        }
        
        .saved-search-item {
            display: inline-block;
            background: white;
            border: 1px solid #3D7F4B;
            border-radius: 4px;
            padding: 8px 12px;
            margin: 5px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .saved-search-item:hover {
            background: #3D7F4B;
            color: white;
        }
        
        .saved-search-item.blend {
            border: 2px solid #7B1FA2;
            background: #f3e5f5;
        }
        
        .saved-search-item.blend:hover {
            background: #7B1FA2;
            color: white;
        }
        
        .saved-search-item.blend::before {
            content: '‚ú® ';
        }
        
        .saved-search-item .delete-btn {
            margin-left: 10px;
            color: #dc3545;
            font-weight: bold;
            cursor: pointer;
        }
        
        .saved-search-item:hover .delete-btn {
            color: white;
        }
        
        .save-search-btn {
            background: #17a2b8;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            font-size: 14px;
            cursor: pointer;
            margin-left: 10px;
        }
        
        .save-search-btn:hover {
            background: #138496;
        }
        
        .blend-mode-section {
            background: #f0f8f0;
            border: 1px solid #3D7F4B;
            border-radius: 4px;
            padding: 15px;
            margin-top: 15px;
            display: none;
        }
        
        .blend-item {
            background: white;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 15px;
            margin-bottom: 15px;
        }
        
        .blend-item-header {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .blend-item label {
            font-weight: 600;
            color: #153D33;
            min-width: 100px;
            margin-bottom: 0;
        }
        
        .blend-item input[type="number"] {
            width: 80px;
        }
        
        .blend-filters {
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid #ddd;
        }
        
        .blend-filter-row {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-bottom: 8px;
            font-size: 13px;
        }
        
        .blend-filter-row select, .blend-filter-row input {
            height: 32px;
            font-size: 13px;
            padding: 6px;
        }
        
        .add-blend-filter-btn {
            background: #17a2b8;
            color: white;
            border: none;
            padding: 5px 12px;
            border-radius: 3px;
            font-size: 12px;
            cursor: pointer;
            height: 28px;
        }
        
        .add-blend-filter-btn:hover {
            background: #138496;
        }
        
        .remove-blend-filter-btn {
            background: #dc3545;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 3px;
            font-size: 12px;
            cursor: pointer;
            height: 28px;
        }
        
        .remove-blend-filter-btn:hover {
            background: #c82333;
        }
        
        .apply-to-all-btn {
            background: #28a745;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 3px;
            font-size: 12px;
            cursor: pointer;
            height: 28px;
        }
        
        .apply-to-all-btn:hover {
            background: #218838;
        }
        
        .blend-mode-btn {
            background: #7B1FA2;
            margin-left: 10px;
        }
        
        .blend-mode-btn:hover {
            background: #6A1B9A;
        }
        
        .date-range-buttons {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .date-range-btn {
            background: #666;
            color: white;
            border: none;
            padding: 6px 14px;
            border-radius: 4px;
            font-size: 13px;
            cursor: pointer;
            height: 32px;
            transition: background 0.3s;
        }
        
        .date-range-btn:hover {
            background: #444;
        }
        
        .date-range-btn.active {
            background: #3D7F4B;
        }
        
        .date-range-custom {
            display: none;
            gap: 10px;
            align-items: center;
            margin-left: auto;
        }
        
        .date-range-custom input {
            width: 140px;
            height: 32px;
            font-size: 13px;
        }
        
        .date-range-custom.show {
            display: flex;
        }
        
        .module-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .module-header h2, .module-header h3 {
            margin: 0;
        }
        
        .hide-btn {
            background: #666;
            color: white;
            border: none;
            padding: 6px 14px;
            border-radius: 4px;
            font-size: 13px;
            cursor: pointer;
            transition: background 0.3s;
        }
        
        .hide-btn:hover {
            background: #444;
        }
        
        .module-content {
            transition: max-height 0.3s ease-out, opacity 0.3s ease-out;
            overflow: hidden;
        }
        
        .module-content.collapsed {
            max-height: 0 !important;
            opacity: 0;
            margin: 0;
            padding: 0;
        }
        
        .table-container {
            overflow-x: auto;
            max-height: 600px;
            overflow-y: auto;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
        }
        
        thead {
            position: sticky;
            top: 0;
            background: #153D33;
            color: white;
            z-index: 10;
        }
        
        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }
        
        th {
            font-weight: 600;
            white-space: nowrap;
        }
        
        tbody tr:hover {
            background: #f5f5f5;
        }
        
        th.sortable {
            cursor: pointer;
            user-select: none;
            position: relative;
            padding-right: 25px;
        }
        
        th.sortable:hover {
            background: #0f2d27;
        }
        
        th.sortable::after {
            content: '‚áÖ';
            position: absolute;
            right: 8px;
            opacity: 0.3;
        }
        
        th.sortable.sort-asc::after {
            content: '‚Üë';
            opacity: 1;
        }
        
        th.sortable.sort-desc::after {
            content: '‚Üì';
            opacity: 1;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
            font-size: 16px;
        }
        
        .error {
            background: #ffebee;
            color: #c62828;
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 20px;
        }
        
        .grid-2 {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
        }
        
        @media (max-width: 768px) {
            .grid-2, .range-container {
                grid-template-columns: 1fr;
            }
            
            .header {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .header-logo {
                height: 45px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <img src="{{ url_for('static', filename='images/fusca-logo.png') }}" alt="Fusca Logo" class="header-logo">
            <div class="header-content">
                <h1>Auction Data Search & Analysis</h1>
                <div class="header-subtitle">Professional wool auction data analysis and insights</div>
            </div>
        </div>
        
        <div class="saved-searches-section" id="savedSearchesSection" style="display: none;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                <h3 style="margin: 0; color: #153D33; font-size: 16px;">Saved Searches</h3>
            </div>
            <div id="savedSearchesList"></div>
        </div>
        
        <div class="search-section">
            <h2 style="margin-bottom: 20px; color: #153D33; font-size: 20px;">Search Wool Auctions</h2>
            
            <div class="search-group">
                <label for="wool_type">Wool Type Search (ID or Type Name)</label>
                <div class="search-bar">
                    <input type="text" id="wool_type" placeholder="e.g. F2N, 1, MULTI... (leave blank for all)">
                    <button onclick="search()" id="searchBtn">Search</button>
                    <button onclick="saveCurrentSearch()" class="save-search-btn">üíæ Save Search</button>
                    <button onclick="resetFilters()" style="background: #666;">Reset</button>
                </div>
            </div>
            
            <div class="filters-container" id="filtersContainer">
                <div class="filters-header">
                    <h3>Column Filters</h3>
                    <button class="add-filter-btn" onclick="addFilter()">+ Add Filter</button>
                </div>
                <div id="filtersList"></div>
            </div>
        </div>
        
        <div class="search-section" style="background: #e8f5e9; border: 2px solid #3D7F4B;">
            <h2 style="margin-bottom: 15px; color: #153D33; font-size: 20px;">üîç Compare Wool Types</h2>
            <div class="search-group">
                <label for="compareTypes">Enter wool types to compare (comma-separated, max 5)</label>
                <div class="search-bar">
                    <input type="text" id="compareTypes" placeholder="e.g. F2N, F3D, MULTI">
                    <button onclick="compareWoolTypes()" id="compareBtn">Compare</button>
                    <button onclick="toggleBlendMode()" class="blend-mode-btn" id="blendModeToggle">Advanced Blend Mode</button>
                </div>
                
                <div id="blendModeSection" class="blend-mode-section">
                    <h4 style="margin-top: 0; color: #153D33;">Weighted Blend Settings</h4>
                    <p style="margin-bottom: 15px; color: #666; font-size: 13px;">
                        Adjust the weight of each wool type to create a blended average line. Higher weights have more influence.
                    </p>
                    
                    <div class="date-range-buttons">
                        <span style="font-weight: 600; color: #153D33; font-size: 14px;">Date Range:</span>
                        <button class="date-range-btn" onclick="setDateRange('6m')">6 Months</button>
                        <button class="date-range-btn" onclick="setDateRange('1y')">1 Year</button>
                        <button class="date-range-btn" onclick="setDateRange('3y')">3 Years</button>
                        <button class="date-range-btn" onclick="toggleCustomDateRange()">Custom</button>
                        <div class="date-range-custom" id="customDateRange">
                            <label style="font-size: 13px; margin: 0;">From:</label>
                            <input type="date" id="customDateFrom" />
                            <label style="font-size: 13px; margin: 0;">To:</label>
                            <input type="date" id="customDateTo" />
                            <button class="date-range-btn" style="background: #3D7F4B;" onclick="applyCustomDateRange()">Apply</button>
                        </div>
                    </div>
                    
                    <div id="blendWeights"></div>
                    <div style="display: flex; justify-content: space-between; margin-top: 15px;">
                        <button onclick="applyBlendedCompare()" style="background: #7B1FA2;">Apply Blend</button>
                        <button onclick="saveBlendSearch()" style="background: #7B1FA2;">üíæ Save Blend</button>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="chart-section" id="compareChartSection" style="display: none;">
            <div class="module-header">
                <h2 style="color: #153D33; font-size: 20px;">Price Comparison</h2>
                <button class="hide-btn" onclick="toggleModule('compareChart')">Hide</button>
            </div>
            <div id="compareChartContent" class="module-content">
                <div class="chart-container">
                    <canvas id="compareChart"></canvas>
                </div>
            </div>
        </div>
        
        <div class="chart-section" id="chartSection" style="display: none;">
            <div class="module-header">
                <h2 style="color: #153D33; font-size: 20px;">Average Price Over Time</h2>
                <button class="hide-btn" onclick="toggleModule('priceChart')">Hide</button>
            </div>
            <div id="priceChartContent" class="module-content">
                <div class="chart-container">
                    <canvas id="priceChart"></canvas>
                </div>
            </div>
        </div>
        
        <div id="errorMsg" class="error" style="display: none;"></div>
        
        <div class="chart-section" id="balesChartSection" style="display: none;">
            <div class="module-header">
                <h2 style="color: #153D33; font-size: 20px;">Total Bales by Sale Date</h2>
                <button class="hide-btn" onclick="toggleModule('balesChart')">Hide</button>
            </div>
            <div id="balesChartContent" class="module-content">
                <div class="chart-container">
                    <canvas id="balesChart"></canvas>
                </div>
            </div>
        </div>
        
        <div id="resultsSection" style="display: none;">
            <div class="module-header" style="background: #e8f5e9; padding: 15px; border-radius: 4px; margin-bottom: 15px;">
                <span class="results-count" id="resultsCount" style="font-weight: 600; color: #153D33; font-size: 16px;">-</span>
                <div style="display: flex; gap: 15px; align-items: center;">
                    <button class="download-csv-btn" onclick="downloadCSV()" id="downloadBtn">üì• Download CSV</button>
                    <span style="color: #666; font-size: 14px;">Showing up to 1,000 results</span>
                    <button class="hide-btn" onclick="toggleModule('resultsTable')">Hide</button>
                </div>
            </div>
            
            <div id="resultsTableContent" class="module-content">
                <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th class="sortable" data-column="sale_date" onclick="sortTable('sale_date')">Sale Date</th>
                            <th class="sortable" data-column="lot_number" onclick="sortTable('lot_number')">Lot Number</th>
                            <th class="sortable" data-column="type_combined" onclick="sortTable('type_combined')">Wool Type</th>
                            <th class="sortable" data-column="price" onclick="sortTable('price')">Price</th>
                            <th class="sortable" data-column="bales" onclick="sortTable('bales')">Bales</th>
                            <th class="sortable" data-column="kg" onclick="sortTable('kg')">KG</th>
                            <th class="sortable" data-column="colour" onclick="sortTable('colour')">Colour</th>
                            <th class="sortable" data-column="micron" onclick="sortTable('micron')">Micron</th>
                            <th class="sortable" data-column="yield" onclick="sortTable('yield')">Yield %</th>
                            <th class="sortable" data-column="vegetable_matter" onclick="sortTable('vegetable_matter')">VM %</th>
                            <th class="sortable" data-column="location" onclick="sortTable('location')">Location</th>
                            <th class="sortable" data-column="seller_name" onclick="sortTable('seller_name')">Seller</th>
                            <th class="sortable" data-column="farm_brand_name" onclick="sortTable('farm_brand_name')">Farm Brand</th>
                            <th class="sortable" data-column="is_sold" onclick="sortTable('is_sold')">Sold</th>
                        </tr>
                    </thead>
                    <tbody id="resultsTable">
                    </tbody>
                </table>
                </div>
            </div>
        </div>
        
        <div id="loading" class="loading" style="display: none;">
            Loading...
        </div>
    </div>

    <script>
        let priceChart = null;
        let balesChart = null;
        let compareChart = null;
        let filterCount = 0;
        let currentResults = [];
        let sortColumn = null;
        let sortDirection = 'asc';
        let blendDateFilter = null;
        
        const columns = [
            { name: 'price', label: 'Price', type: 'number' },
            { name: 'bales', label: 'Bales', type: 'number' },
            { name: 'kg', label: 'KG', type: 'number' },
            { name: 'colour', label: 'Colour', type: 'number' },
            { name: 'micron', label: 'Micron', type: 'number' },
            { name: 'yield', label: 'Yield %', type: 'number' },
            { name: 'vegetable_matter', label: 'Vegetable Matter %', type: 'number' },
            { name: 'sale_date', label: 'Sale Date', type: 'date' },
            { name: 'location', label: 'Location', type: 'text' },
            { name: 'seller_name', label: 'Seller', type: 'text' },
            { name: 'farm_brand_name', label: 'Farm Brand', type: 'text' }
        ];
        
        const operators = {
            number: [
                { value: 'eq', label: 'Equals' },
                { value: 'ne', label: 'Not Equals' },
                { value: 'gt', label: 'Greater Than' },
                { value: 'lt', label: 'Less Than' },
                { value: 'gte', label: 'Greater Than or Equal' },
                { value: 'lte', label: 'Less Than or Equal' },
                { value: 'between', label: 'Between' }
            ],
            text: [
                { value: 'contains', label: 'Contains' },
                { value: 'not_contains', label: 'Does Not Contain' },
                { value: 'eq', label: 'Equals' },
                { value: 'ne', label: 'Not Equals' }
            ],
            date: [
                { value: 'eq', label: 'Equals' },
                { value: 'gt', label: 'After' },
                { value: 'lt', label: 'Before' },
                { value: 'between', label: 'Between' }
            ]
        };
        
        function addFilter() {
            const filterId = `filter_${filterCount++}`;
            const filtersList = document.getElementById('filtersList');
            
            const filterDiv = document.createElement('div');
            filterDiv.className = 'filter-row';
            filterDiv.id = filterId;
            
            filterDiv.innerHTML = `
                <select class="filter-column" onchange="updateFilterOperators('${filterId}')">
                    <option value="">Select Column</option>
                    ${columns.map(col => `<option value="${col.name}" data-type="${col.type}">${col.label}</option>`).join('')}
                </select>
                <select class="filter-operator">
                    <option value="">Select Operator</option>
                </select>
                <input type="text" class="filter-value" placeholder="Value">
                <input type="text" class="filter-value2" placeholder="Value 2" style="display:none;">
                <button class="remove-filter" onclick="removeFilter('${filterId}')">Remove</button>
            `;
            
            filtersList.appendChild(filterDiv);
        }
        
        function updateFilterOperators(filterId) {
            const filterDiv = document.getElementById(filterId);
            const columnSelect = filterDiv.querySelector('.filter-column');
            const operatorSelect = filterDiv.querySelector('.filter-operator');
            const valueInput = filterDiv.querySelector('.filter-value');
            const value2Input = filterDiv.querySelector('.filter-value2');
            
            const selectedOption = columnSelect.options[columnSelect.selectedIndex];
            const columnType = selectedOption.getAttribute('data-type');
            
            operatorSelect.innerHTML = '<option value="">Select Operator</option>';
            value2Input.style.display = 'none';
            
            if (columnType && operators[columnType]) {
                operators[columnType].forEach(op => {
                    const option = document.createElement('option');
                    option.value = op.value;
                    option.textContent = op.label;
                    operatorSelect.appendChild(option);
                });
            }
            
            // Update input type based on column type
            if (columnType === 'number') {
                valueInput.type = 'number';
                valueInput.step = '0.1';
                value2Input.type = 'number';
                value2Input.step = '0.1';
            } else if (columnType === 'date') {
                valueInput.type = 'date';
                value2Input.type = 'date';
            } else {
                valueInput.type = 'text';
                value2Input.type = 'text';
            }
            
            operatorSelect.onchange = function() {
                value2Input.style.display = this.value === 'between' ? 'block' : 'none';
            };
        }
        
        function removeFilter(filterId) {
            document.getElementById(filterId).remove();
        }
        
        function getFilters() {
            const filters = {};
            
            const woolType = document.getElementById('wool_type').value.trim();
            if (woolType) filters.wool_type_search = woolType;
            
            // Collect column filters
            filters.column_filters = [];
            const filterRows = document.querySelectorAll('.filter-row');
            filterRows.forEach(row => {
                const column = row.querySelector('.filter-column').value;
                const operator = row.querySelector('.filter-operator').value;
                const value = row.querySelector('.filter-value').value;
                const value2 = row.querySelector('.filter-value2').value;
                
                if (column && operator && value) {
                    filters.column_filters.push({
                        column,
                        operator,
                        value,
                        value2: operator === 'between' ? value2 : null
                    });
                }
            });
            
            return filters;
        }
        
        async function search() {
            const filters = getFilters();
            
            console.log('Searching with filters:', filters);
            
            document.getElementById('loading').style.display = 'block';
            document.getElementById('resultsSection').style.display = 'none';
            document.getElementById('chartSection').style.display = 'none';
            document.getElementById('balesChartSection').style.display = 'none';
            document.getElementById('errorMsg').style.display = 'none';
            document.getElementById('searchBtn').disabled = true;
            
            try {
                // Step 1: Fetch and display price chart FIRST
                console.log('Step 1: Fetching price chart...');
                const chartResponse = await fetch('/api/price_chart', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(filters)
                });
                
                if (chartResponse.ok) {
                    const chartData = await chartResponse.json();
                    if (!chartData.error) {
                        console.log('‚úÖ Price chart loaded');
                        displayChart(chartData);
                    } else {
                        console.warn('Price chart error:', chartData.error);
                    }
                } else {
                    console.warn('Price chart failed with status:', chartResponse.status);
                }
                
                // Wait a moment before next request
                await new Promise(resolve => setTimeout(resolve, 500));
                
                // Step 2: Fetch and display bales chart SECOND
                console.log('Step 2: Fetching bales chart...');
                const balesChartResponse = await fetch('/api/bales_chart', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(filters)
                });
                
                if (balesChartResponse.ok) {
                    const balesChartData = await balesChartResponse.json();
                    if (!balesChartData.error) {
                        console.log('‚úÖ Bales chart loaded');
                        displayBalesChart(balesChartData);
                    } else {
                        console.warn('Bales chart error:', balesChartData.error);
                    }
                } else {
                    console.warn('Bales chart failed with status:', balesChartResponse.status);
                }
                
                // Wait a moment before next request
                await new Promise(resolve => setTimeout(resolve, 500));
                
                // Step 3: Fetch and display table data LAST
                console.log('Step 3: Fetching search results...');
                const resultsResponse = await fetch('/api/search', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(filters)
                });
                
                if (!resultsResponse.ok) {
                    throw new Error(`Server error: ${resultsResponse.status}`);
                }
                
                const resultsData = await resultsResponse.json();
                console.log('‚úÖ Search results:', resultsData.count, 'records');
                
                if (resultsData.error) {
                    throw new Error(resultsData.error);
                }
                
                // Display results
                displayResults(resultsData);
                
            } catch (error) {
                console.error('Search error:', error);
                showError('Search failed: ' + error.message);
            } finally {
                document.getElementById('loading').style.display = 'none';
                document.getElementById('searchBtn').disabled = false;
            }
        }
        
        function displayResults(data) {
            const tbody = document.getElementById('resultsTable');
            tbody.innerHTML = '';
            
            // Store results for CSV export
            currentResults = data.results;
            
            document.getElementById('resultsCount').textContent = `Found ${data.count} results`;
            document.getElementById('resultsSection').style.display = 'block';
            
            data.results.forEach(row => {
                // Convert price from cents to dollars
                const priceInDollars = row.price / 100;
                
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${row.sale_date || '-'}</td>
                    <td>${row.lot_number ? row.lot_number.trim() : '-'}</td>
                    <td>${row.type_combined || '-'}</td>
                    <td style="font-weight: 600;">$${priceInDollars.toFixed(2)}</td>
                    <td>${row.bales}</td>
                    <td>${row.kg.toLocaleString()}</td>
                    <td>${row.colour ? row.colour.toFixed(1) : '-'}</td>
                    <td>${row.micron ? row.micron.toFixed(1) : '-'}</td>
                    <td>${row.yield ? row.yield.toFixed(1) : '-'}</td>
                    <td>${row.vegetable_matter ? row.vegetable_matter.toFixed(1) : '-'}</td>
                    <td>${row.location || '-'}</td>
                    <td>${row.seller_name || '-'}</td>
                    <td>${row.farm_brand_name || '-'}</td>
                    <td>${row.is_sold ? '‚úì' : '‚úó'}</td>
                `;
                tbody.appendChild(tr);
            });
        }
        
        function displayChart(data) {
            document.getElementById('chartSection').style.display = 'block';
            
            const ctx = document.getElementById('priceChart').getContext('2d');
            
            // Destroy existing chart
            if (priceChart) {
                priceChart.destroy();
            }
            
            priceChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.labels,
                    datasets: [{
                        label: 'Average Price',
                        data: data.data,
                        borderColor: '#3D7F4B',
                        backgroundColor: 'rgba(61, 127, 75, 0.1)',
                        borderWidth: 2,
                        tension: 0.1,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top'
                        },
                            tooltip: {
                                mode: 'index',
                                intersect: false,
                                callbacks: {
                                    label: function(context) {
                                        return 'Avg Price (filtered): $' + context.parsed.y.toFixed(2);
                                    }
                                }
                            }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Price ($)'
                            },
                            ticks: {
                                callback: function(value) {
                                    return '$' + value;
                                }
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Sale Date'
                            },
                            ticks: {
                                maxRotation: 45,
                                minRotation: 45,
                                maxTicksLimit: 20
                            }
                        }
                    }
                }
            });
        }
        
        function displayBalesChart(data) {
            document.getElementById('balesChartSection').style.display = 'block';
            
            const ctx = document.getElementById('balesChart').getContext('2d');
            
            // Destroy existing chart
            if (balesChart) {
                balesChart.destroy();
            }
            
            balesChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: data.labels,
                    datasets: [{
                        label: 'Total Bales',
                        data: data.data,
                        backgroundColor: '#3D7F4B',
                        borderColor: '#153D33',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top'
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                            callbacks: {
                                label: function(context) {
                                    return 'Total Bales: ' + context.parsed.y.toLocaleString();
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Total Bales'
                            },
                            ticks: {
                                callback: function(value) {
                                    return value.toLocaleString();
                                }
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Sale Date'
                            },
                            ticks: {
                                maxRotation: 45,
                                minRotation: 45,
                                maxTicksLimit: 20
                            }
                        }
                    }
                }
            });
        }
        
        function resetFilters() {
            // Clear text input
            document.getElementById('wool_type').value = '';
            
            // Remove all filters
            document.getElementById('filtersList').innerHTML = '';
            filterCount = 0;
            
            // Hide results and charts
            document.getElementById('resultsSection').style.display = 'none';
            document.getElementById('chartSection').style.display = 'none';
            document.getElementById('balesChartSection').style.display = 'none';
            document.getElementById('errorMsg').style.display = 'none';
            
            console.log('Filters reset');
        }
        
        function showError(message) {
            const errorDiv = document.getElementById('errorMsg');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
        }
        
        function downloadCSV() {
            if (!currentResults || currentResults.length === 0) {
                alert('No results to download');
                return;
            }
            
            // Define CSV headers
            const headers = [
                'Sale Date', 'Lot Number', 'Wool Type ID', 'Type Combined', 
                'Price ($)', 'Bales', 'KG', 'Colour', 'Micron', 'Yield %', 
                'VM %', 'Location', 'Seller', 'Farm Brand', 'Sold'
            ];
            
            // Convert data to CSV format
            let csvContent = headers.join(',') + '\n';
            
            currentResults.forEach(row => {
                const priceInDollars = (row.price / 100).toFixed(2);
                
                const rowData = [
                    row.sale_date || '',
                    (row.lot_number || '').trim(),
                    row.wool_type_id || '',
                    escapeCSV(row.type_combined || ''),
                    priceInDollars,
                    row.bales || '',
                    row.kg || '',
                    row.colour ? row.colour.toFixed(1) : '',
                    row.micron ? row.micron.toFixed(1) : '',
                    row.yield ? row.yield.toFixed(1) : '',
                    row.vegetable_matter ? row.vegetable_matter.toFixed(1) : '',
                    escapeCSV(row.location || ''),
                    escapeCSV(row.seller_name || ''),
                    escapeCSV(row.farm_brand_name || ''),
                    row.is_sold ? 'Yes' : 'No'
                ];
                
                csvContent += rowData.join(',') + '\n';
            });
            
            // Create download link
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            
            // Generate filename with timestamp
            const timestamp = new Date().toISOString().slice(0, 19).replace(/:/g, '-');
            const filename = `auction_data_${timestamp}.csv`;
            
            link.setAttribute('href', url);
            link.setAttribute('download', filename);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            console.log(`Downloaded ${currentResults.length} results to ${filename}`);
        }
        
        function escapeCSV(str) {
            if (str == null) return '';
            str = String(str);
            // If the string contains comma, quote, or newline, wrap it in quotes and escape quotes
            if (str.includes(',') || str.includes('"') || str.includes('\n')) {
                return '"' + str.replace(/"/g, '""') + '"';
            }
            return str;
        }
        
        // Date Range Functions for Blend Mode
        function setDateRange(range) {
            const today = new Date();
            let fromDate;
            
            // Clear active state
            document.querySelectorAll('.date-range-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            
            // Hide custom range
            document.getElementById('customDateRange').classList.remove('show');
            
            // Calculate date range
            if (range === '6m') {
                fromDate = new Date(today);
                fromDate.setMonth(fromDate.getMonth() - 6);
            } else if (range === '1y') {
                fromDate = new Date(today);
                fromDate.setFullYear(fromDate.getFullYear() - 1);
            } else if (range === '3y') {
                fromDate = new Date(today);
                fromDate.setFullYear(fromDate.getFullYear() - 3);
            }
            
            // Set blend date filter
            blendDateFilter = {
                column: 'sale_date',
                operator: 'between',
                value: fromDate.toISOString().split('T')[0],
                value2: today.toISOString().split('T')[0]
            };
            
            console.log('Date range set:', range, blendDateFilter);
        }
        
        function toggleCustomDateRange() {
            const customSection = document.getElementById('customDateRange');
            
            // Clear other active states
            document.querySelectorAll('.date-range-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            
            if (customSection.classList.contains('show')) {
                customSection.classList.remove('show');
            } else {
                customSection.classList.add('show');
            }
        }
        
        function applyCustomDateRange() {
            const fromDate = document.getElementById('customDateFrom').value;
            const toDate = document.getElementById('customDateTo').value;
            
            if (!fromDate || !toDate) {
                alert('Please select both From and To dates');
                return;
            }
            
            if (fromDate > toDate) {
                alert('From date must be before To date');
                return;
            }
            
            // Set blend date filter
            blendDateFilter = {
                column: 'sale_date',
                operator: 'between',
                value: fromDate,
                value2: toDate
            };
            
            console.log('Custom date range set:', blendDateFilter);
        }
        
        // Blend Mode Functions
        function toggleBlendMode() {
            const section = document.getElementById('blendModeSection');
            const button = document.getElementById('blendModeToggle');
            const input = document.getElementById('compareTypes').value.trim();
            
            if (section.style.display === 'none' || !section.style.display) {
                // Validate input first
                if (!input) {
                    alert('Please enter wool types first');
                    return;
                }
                
                const woolTypes = input.split(',').map(t => t.trim()).filter(t => t);
                if (woolTypes.length === 0) {
                    alert('Please enter wool types first');
                    return;
                }
                
                // Show blend mode and populate weights
                section.style.display = 'block';
                button.textContent = 'Hide Blend Mode';
                populateBlendWeights(woolTypes);
            } else {
                section.style.display = 'none';
                button.textContent = 'Advanced Blend Mode';
            }
        }
        
        function populateBlendWeights(woolTypes) {
            const container = document.getElementById('blendWeights');
            container.innerHTML = '';
            
            woolTypes.forEach((type, idx) => {
                const div = document.createElement('div');
                div.className = 'blend-item';
                div.innerHTML = `
                    <div class="blend-item-header">
                        <label>${type}:</label>
                        <input type="number" id="weight_${idx}" value="1" min="0" step="0.1" />
                        <span style="color: #666; font-size: 13px;">weight</span>
                    </div>
                    <div class="blend-filters">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                            <span style="font-size: 13px; color: #666;">Custom filters for ${type}:</span>
                            <button class="add-blend-filter-btn" onclick="addBlendFilter(${idx})">+ Add Filter</button>
                        </div>
                        <div id="blend_filters_${idx}"></div>
                    </div>
                `;
                container.appendChild(div);
            });
        }
        
        function addBlendFilter(typeIdx) {
            const container = document.getElementById(`blend_filters_${typeIdx}`);
            const filterId = `blend_${typeIdx}_${Date.now()}`;
            
            const filterRow = document.createElement('div');
            filterRow.className = 'blend-filter-row';
            filterRow.id = filterId;
            filterRow.setAttribute('data-type-idx', typeIdx);
            filterRow.innerHTML = `
                <select class="blend-filter-column">
                    <option value="">Select Column</option>
                    ${columns.filter(c => c.name !== 'sale_date').map(col => 
                        `<option value="${col.name}" data-type="${col.type}">${col.label}</option>`
                    ).join('')}
                </select>
                <select class="blend-filter-operator">
                    <option value="">Operator</option>
                    <option value="gt">></option>
                    <option value="lt"><</option>
                    <option value="gte">>=</option>
                    <option value="lte"><=</option>
                    <option value="eq">=</option>
                    <option value="between">Between</option>
                </select>
                <input type="text" class="blend-filter-value" placeholder="Value" />
                <input type="text" class="blend-filter-value2" placeholder="Value 2" style="display:none;" />
                <button class="apply-to-all-btn" onclick="applyFilterToAll('${filterId}', ${typeIdx})" title="Apply this filter to all types">Apply to All</button>
                <button class="remove-blend-filter-btn" onclick="removeBlendFilter('${filterId}')">‚úï</button>
            `;
            
            // Add operator change handler
            const operatorSelect = filterRow.querySelector('.blend-filter-operator');
            operatorSelect.onchange = function() {
                const value2 = filterRow.querySelector('.blend-filter-value2');
                value2.style.display = this.value === 'between' ? 'inline-block' : 'none';
            };
            
            container.appendChild(filterRow);
        }
        
        function applyFilterToAll(filterId, sourceTypeIdx) {
            const sourceRow = document.getElementById(filterId);
            if (!sourceRow) return;
            
            // Get filter values from source
            const column = sourceRow.querySelector('.blend-filter-column').value;
            const operator = sourceRow.querySelector('.blend-filter-operator').value;
            const value = sourceRow.querySelector('.blend-filter-value').value;
            const value2 = sourceRow.querySelector('.blend-filter-value2').value;
            
            if (!column || !operator || !value) {
                alert('Please fill in all filter fields first');
                return;
            }
            
            // Get total number of types
            const input = document.getElementById('compareTypes').value.trim();
            const woolTypes = input.split(',').map(t => t.trim()).filter(t => t);
            
            // Apply to all other types
            woolTypes.forEach((type, idx) => {
                if (idx !== sourceTypeIdx) {
                    // Add filter to this type
                    addBlendFilter(idx);
                    const container = document.getElementById(`blend_filters_${idx}`);
                    const newRow = container.lastElementChild;
                    
                    newRow.querySelector('.blend-filter-column').value = column;
                    newRow.querySelector('.blend-filter-operator').value = operator;
                    newRow.querySelector('.blend-filter-value').value = value;
                    
                    if (operator === 'between' && value2) {
                        newRow.querySelector('.blend-filter-value2').value = value2;
                        newRow.querySelector('.blend-filter-value2').style.display = 'inline-block';
                    }
                }
            });
            
            console.log(`Applied filter to all types: ${column} ${operator} ${value}`);
        }
        
        function removeBlendFilter(filterId) {
            document.getElementById(filterId).remove();
        }
        
        async function applyBlendedCompare() {
            const input = document.getElementById('compareTypes').value.trim();
            const woolTypes = input.split(',').map(t => t.trim()).filter(t => t);
            
            // Get weights
            const weights = [];
            woolTypes.forEach((type, idx) => {
                const weight = parseFloat(document.getElementById(`weight_${idx}`).value) || 1;
                weights.push(weight);
            });
            
            // Collect per-type filters
            const typeFilters = [];
            woolTypes.forEach((type, idx) => {
                const filters = [];
                const container = document.getElementById(`blend_filters_${idx}`);
                if (container) {
                    container.querySelectorAll('.blend-filter-row').forEach(row => {
                        const column = row.querySelector('.blend-filter-column').value;
                        const operator = row.querySelector('.blend-filter-operator').value;
                        const value = row.querySelector('.blend-filter-value').value;
                        const value2 = row.querySelector('.blend-filter-value2').value;
                        
                        if (column && operator && value) {
                            filters.push({ column, operator, value, value2: operator === 'between' ? value2 : null });
                        }
                    });
                }
                typeFilters.push(filters);
            });
            
            // Use blend date filter (set by date range buttons)
            const hasDateFilter = blendDateFilter !== null;
            
            if (!hasDateFilter) {
                const proceed = confirm(
                    '‚ö†Ô∏è No date range selected!\n\n' +
                    'This query will process all historical data and may take 10-30 seconds.\n\n' +
                    'TIP: Select a date range (6 Months, 1 Year, or Custom) for faster results.\n\n' +
                    'Continue anyway?'
                );
                if (!proceed) return;
            }
            
            document.getElementById('compareBtn').disabled = true;
            document.getElementById('compareChartSection').style.display = 'none';
            
            try {
                console.log('Comparing with blend:', woolTypes, 'Weights:', weights, 'Type filters:', typeFilters);
                
                const response = await fetch('/api/compare_chart_blend', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        wool_types: woolTypes,
                        type_filters: typeFilters,
                        date_filter: blendDateFilter
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`Server error: ${response.status}`);
                }
                
                const data = await response.json();
                
                if (data.error) {
                    throw new Error(data.error);
                }
                
                // Display with blend
                displayBlendedChart(data, woolTypes, weights);
                
            } catch (error) {
                console.error('Blend compare error:', error);
                alert('Comparison failed: ' + error.message);
            } finally {
                document.getElementById('compareBtn').disabled = false;
            }
        }
        
        function interpolateDataset(dataArray) {
            // Fill missing data points using linear interpolation
            const interpolated = [...dataArray];
            
            for (let i = 0; i < interpolated.length; i++) {
                if (interpolated[i] === null || interpolated[i] === undefined) {
                    // Find previous valid point
                    let prevIdx = i - 1;
                    while (prevIdx >= 0 && (interpolated[prevIdx] === null || interpolated[prevIdx] === undefined)) {
                        prevIdx--;
                    }
                    
                    // Find next valid point
                    let nextIdx = i + 1;
                    while (nextIdx < interpolated.length && (interpolated[nextIdx] === null || interpolated[nextIdx] === undefined)) {
                        nextIdx++;
                    }
                    
                    // Interpolate if we have both prev and next
                    if (prevIdx >= 0 && nextIdx < interpolated.length) {
                        const prevValue = interpolated[prevIdx];
                        const nextValue = interpolated[nextIdx];
                        const distance = nextIdx - prevIdx;
                        const position = i - prevIdx;
                        
                        // Linear interpolation
                        interpolated[i] = prevValue + (nextValue - prevValue) * (position / distance);
                    }
                    // If only prev exists, use prev (flat line forward)
                    else if (prevIdx >= 0) {
                        interpolated[i] = interpolated[prevIdx];
                    }
                    // If only next exists, use next (flat line backward)
                    else if (nextIdx < interpolated.length) {
                        interpolated[i] = interpolated[nextIdx];
                    }
                }
            }
            
            return interpolated;
        }
        
        function displayBlendedChart(data, woolTypes, weights) {
            document.getElementById('compareChartSection').style.display = 'block';
            
            const ctx = document.getElementById('compareChart').getContext('2d');
            
            if (compareChart) {
                compareChart.destroy();
            }
            
            // Interpolate missing values in each dataset first
            const interpolatedDatasets = data.datasets.map(dataset => ({
                ...dataset,
                data: interpolateDataset(dataset.data)
            }));
            
            // Calculate weighted average for each date using interpolated data
            const blendedData = [];
            const labels = data.labels;
            
            for (let i = 0; i < labels.length; i++) {
                let weightedSum = 0;
                let totalWeight = 0;
                
                interpolatedDatasets.forEach((dataset, idx) => {
                    const value = dataset.data[i];
                    if (value !== null && value !== undefined) {
                        weightedSum += value * weights[idx];
                        totalWeight += weights[idx];
                    }
                });
                
                blendedData.push(totalWeight > 0 ? weightedSum / totalWeight : null);
            }
            
            // Create datasets: individual types (75% opacity) + blended line (bold)
            const colors = ['#3D7F4B', '#1976D2', '#D32F2F', '#F57C00', '#7B1FA2'];
            const datasets = [];
            
            // Add individual type lines (80% opacity, using interpolated data)
            interpolatedDatasets.forEach((dataset, idx) => {
                datasets.push({
                    label: woolTypes[idx] + ` (weight: ${weights[idx]})`,
                    data: dataset.data,
                    borderColor: colors[idx % colors.length] + 'CC',  // 80% opacity
                    backgroundColor: 'transparent',
                    borderWidth: 1.5,
                    tension: 0.1,
                    fill: false,
                    spanGaps: false,  // Don't span gaps, we interpolated them
                    pointRadius: 0
                });
            });
            
            // Add blended average line (bold)
            datasets.push({
                label: '‚ú® Weighted Average',
                data: blendedData,
                borderColor: '#153D33',
                backgroundColor: 'rgba(21, 61, 51, 0.1)',
                borderWidth: 3,
                tension: 0.1,
                fill: true,
                spanGaps: true,
                pointRadius: 2,
                pointBackgroundColor: '#153D33'
            });
            
            compareChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'index',
                        intersect: false
                    },
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top'
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                            callbacks: {
                                label: function(context) {
                                    const value = context.parsed.y;
                                    if (value === null) return null;
                                    return context.dataset.label + ': $' + value.toFixed(2);
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Average Price ($)'
                            },
                            ticks: {
                                callback: function(value) {
                                    return '$' + value;
                                }
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Sale Date'
                            },
                            ticks: {
                                maxRotation: 45,
                                minRotation: 45,
                                maxTicksLimit: 20
                            }
                        }
                    }
                }
            });
        }
        
        // Comparison Chart Functions
        async function compareWoolTypes() {
            const input = document.getElementById('compareTypes').value.trim();
            
            if (!input) {
                alert('Please enter wool types to compare');
                return;
            }
            
            // Split by comma and trim
            const woolTypes = input.split(',').map(t => t.trim()).filter(t => t);
            
            if (woolTypes.length === 0) {
                alert('Please enter at least one wool type');
                return;
            }
            
            if (woolTypes.length > 5) {
                alert('Maximum 5 wool types for comparison');
                return;
            }
            
            // Check if user has date filters
            const filters = getFilters();
            const hasDateFilter = filters.column_filters && 
                filters.column_filters.some(f => f.column === 'sale_date');
            
            if (!hasDateFilter) {
                const proceed = confirm(
                    '‚ö†Ô∏è No date filter detected!\n\n' +
                    'This query will process all historical data and may take 10-30 seconds.\n\n' +
                    'TIP: Add a date filter (e.g. "Sale Date > 2024-01-01") for faster results.\n\n' +
                    'Continue anyway?'
                );
                
                if (!proceed) return;
            }
            
            document.getElementById('compareBtn').disabled = true;
            document.getElementById('compareChartSection').style.display = 'none';
            
            try {
                console.log('Comparing wool types:', woolTypes);
                
                const response = await fetch('/api/compare_chart', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        wool_types: woolTypes,
                        column_filters: getFilters().column_filters || []
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`Server error: ${response.status}`);
                }
                
                const data = await response.json();
                
                if (data.error) {
                    throw new Error(data.error);
                }
                
                displayCompareChart(data);
                
            } catch (error) {
                console.error('Compare error:', error);
                alert('Comparison failed: ' + error.message);
            } finally {
                document.getElementById('compareBtn').disabled = false;
            }
        }
        
        function displayCompareChart(data) {
            document.getElementById('compareChartSection').style.display = 'block';
            
            const ctx = document.getElementById('compareChart').getContext('2d');
            
            // Destroy existing chart
            if (compareChart) {
                compareChart.destroy();
            }
            
            compareChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.labels,
                    datasets: data.datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'index',
                        intersect: false
                    },
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top'
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                            callbacks: {
                                label: function(context) {
                                    return context.dataset.label + ': $' + context.parsed.y.toFixed(2);
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Average Price ($)'
                            },
                            ticks: {
                                callback: function(value) {
                                    return '$' + value;
                                }
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Sale Date'
                            },
                            ticks: {
                                maxRotation: 45,
                                minRotation: 45,
                                maxTicksLimit: 20
                            }
                        }
                    }
                }
            });
        }
        
        // Save Blend Search Function
        async function saveBlendSearch() {
            const input = document.getElementById('compareTypes').value.trim();
            const woolTypes = input.split(',').map(t => t.trim()).filter(t => t);
            
            if (woolTypes.length === 0) {
                alert('Please enter wool types first');
                return;
            }
            
            const name = prompt('Enter a name for this blend:');
            if (!name) return;
            
            // Collect weights
            const weights = [];
            woolTypes.forEach((type, idx) => {
                const weight = parseFloat(document.getElementById(`weight_${idx}`).value) || 1;
                weights.push(weight);
            });
            
            // Collect per-type filters
            const typeFilters = [];
            woolTypes.forEach((type, idx) => {
                const filters = [];
                const container = document.getElementById(`blend_filters_${idx}`);
                if (container) {
                    container.querySelectorAll('.blend-filter-row').forEach(row => {
                        const column = row.querySelector('.blend-filter-column').value;
                        const operator = row.querySelector('.blend-filter-operator').value;
                        const value = row.querySelector('.blend-filter-value').value;
                        const value2 = row.querySelector('.blend-filter-value2').value;
                        
                        if (column && operator && value) {
                            filters.push({ column, operator, value, value2 });
                        }
                    });
                }
                typeFilters.push(filters);
            });
            
            // Get existing saved searches
            let savedSearches = JSON.parse(localStorage.getItem('fusca_saved_searches') || '[]');
            
            // Add blend search (using blend module's date filter, not global)
            savedSearches.push({
                id: Date.now(),
                name: name,
                type: 'blend',
                woolTypes: woolTypes,
                weights: weights,
                typeFilters: typeFilters,
                dateFilter: blendDateFilter,
                created: new Date().toISOString()
            });
            
            // Save to localStorage
            localStorage.setItem('fusca_saved_searches', JSON.stringify(savedSearches));
            
            // Log to server
            try {
                await fetch('/api/log_saved_search', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        name: name, 
                        type: 'blend',
                        blend_data: { woolTypes, weights, typeFilters, dateFilter }
                    })
                });
            } catch (e) {
                console.warn('Failed to log saved blend:', e);
            }
            
            // Refresh display
            renderSavedSearches();
            
            console.log('Blend saved:', name);
            alert(`Blend "${name}" saved successfully!`);
        }
        
        // Saved Searches Functions
        async function saveCurrentSearch() {
            const filters = getFilters();
            const name = prompt('Enter a name for this search:');
            
            if (!name) return;
            
            // Get existing saved searches
            let savedSearches = JSON.parse(localStorage.getItem('fusca_saved_searches') || '[]');
            
            // Add new search
            savedSearches.push({
                id: Date.now(),
                name: name,
                filters: filters,
                created: new Date().toISOString()
            });
            
            // Save to localStorage
            localStorage.setItem('fusca_saved_searches', JSON.stringify(savedSearches));
            
            // Log to server
            try {
                await fetch('/api/log_saved_search', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name: name, filters: filters })
                });
            } catch (e) {
                console.warn('Failed to log saved search:', e);
            }
            
            // Refresh display
            renderSavedSearches();
            
            console.log('Search saved:', name);
        }
        
        function loadSavedSearch(searchId) {
            const savedSearches = JSON.parse(localStorage.getItem('fusca_saved_searches') || '[]');
            const savedSearch = savedSearches.find(s => s.id === searchId);
            
            if (!savedSearch) return;
            
            // Check if it's a blend search
            if (savedSearch.type === 'blend') {
                loadBlendSearch(savedSearch);
                return;
            }
            
            // Regular search loading
            // Clear current filters
            document.getElementById('filtersList').innerHTML = '';
            filterCount = 0;
            
            // Set wool type search
            document.getElementById('wool_type').value = savedSearch.filters.wool_type_search || '';
            
            // Recreate column filters
            if (savedSearch.filters.column_filters) {
                savedSearch.filters.column_filters.forEach(filter => {
                    addFilter();
                    const lastFilter = document.getElementById('filtersList').lastElementChild;
                    lastFilter.querySelector('.filter-column').value = filter.column;
                    updateFilterOperators(lastFilter.id);
                    lastFilter.querySelector('.filter-operator').value = filter.operator;
                    lastFilter.querySelector('.filter-value').value = filter.value;
                    if (filter.value2) {
                        lastFilter.querySelector('.filter-value2').value = filter.value2;
                        lastFilter.querySelector('.filter-value2').style.display = 'block';
                    }
                });
            }
            
            console.log('Loaded saved search:', savedSearch.name);
            
            // Automatically run the search
            search();
        }
        
        function loadBlendSearch(savedSearch) {
            console.log('Loading blend search:', savedSearch.name);
            
            // Clear main search filters
            document.getElementById('filtersList').innerHTML = '';
            filterCount = 0;
            document.getElementById('wool_type').value = '';
            
            // Restore date filter to blend module
            blendDateFilter = savedSearch.dateFilter;
            
            // Set wool types in compare input
            document.getElementById('compareTypes').value = savedSearch.woolTypes.join(', ');
            
            // Show blend mode
            const section = document.getElementById('blendModeSection');
            const button = document.getElementById('blendModeToggle');
            section.style.display = 'block';
            button.textContent = 'Hide Blend Mode';
            
            // Populate weights
            populateBlendWeights(savedSearch.woolTypes);
            
            // Set weight values
            savedSearch.woolTypes.forEach((type, idx) => {
                document.getElementById(`weight_${idx}`).value = savedSearch.weights[idx];
            });
            
            // Populate per-type filters
            savedSearch.woolTypes.forEach((type, idx) => {
                if (savedSearch.typeFilters[idx]) {
                    savedSearch.typeFilters[idx].forEach(filter => {
                        addBlendFilter(idx);
                        const container = document.getElementById(`blend_filters_${idx}`);
                        const lastRow = container.lastElementChild;
                        lastRow.querySelector('.blend-filter-column').value = filter.column;
                        lastRow.querySelector('.blend-filter-operator').value = filter.operator;
                        lastRow.querySelector('.blend-filter-value').value = filter.value;
                        if (filter.value2 && filter.operator === 'between') {
                            lastRow.querySelector('.blend-filter-value2').value = filter.value2;
                            lastRow.querySelector('.blend-filter-value2').style.display = 'inline-block';
                        }
                    });
                }
            });
            
            // Automatically run the blend
            applyBlendedCompare();
        }
        
        function deleteSavedSearch(searchId) {
            if (!confirm('Delete this saved search?')) return;
            
            let savedSearches = JSON.parse(localStorage.getItem('fusca_saved_searches') || '[]');
            savedSearches = savedSearches.filter(s => s.id !== searchId);
            localStorage.setItem('fusca_saved_searches', JSON.stringify(savedSearches));
            
            renderSavedSearches();
        }
        
        function renderSavedSearches() {
            const savedSearches = JSON.parse(localStorage.getItem('fusca_saved_searches') || '[]');
            const container = document.getElementById('savedSearchesList');
            const section = document.getElementById('savedSearchesSection');
            
            if (savedSearches.length === 0) {
                section.style.display = 'none';
                return;
            }
            
            section.style.display = 'block';
            container.innerHTML = '';
            
            savedSearches.forEach(search => {
                const item = document.createElement('div');
                item.className = 'saved-search-item' + (search.type === 'blend' ? ' blend' : '');
                item.innerHTML = `
                    <span onclick="loadSavedSearch(${search.id})">${search.name}</span>
                    <span class="delete-btn" onclick="event.stopPropagation(); deleteSavedSearch(${search.id})">‚úï</span>
                `;
                container.appendChild(item);
            });
        }
        
        function sortTable(column) {
            // Toggle sort direction if clicking same column
            if (sortColumn === column) {
                sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
            } else {
                sortColumn = column;
                sortDirection = 'asc';
            }
            
            // Update header styling
            document.querySelectorAll('th.sortable').forEach(th => {
                th.classList.remove('sort-asc', 'sort-desc');
            });
            const header = document.querySelector(`th[data-column="${column}"]`);
            if (header) {
                header.classList.add(`sort-${sortDirection}`);
            }
            
            // Sort the current results
            const sorted = [...currentResults].sort((a, b) => {
                let aVal = a[column];
                let bVal = b[column];
                
                // Handle null/undefined values
                if (aVal == null) aVal = '';
                if (bVal == null) bVal = '';
                
                // Convert to number if numeric column
                if (column === 'price' || column === 'bales' || column === 'kg' || 
                    column === 'colour' || column === 'micron' || column === 'yield' || 
                    column === 'vegetable_matter') {
                    aVal = parseFloat(aVal) || 0;
                    bVal = parseFloat(bVal) || 0;
                }
                
                // Compare
                if (aVal < bVal) return sortDirection === 'asc' ? -1 : 1;
                if (aVal > bVal) return sortDirection === 'asc' ? 1 : -1;
                return 0;
            });
            
            // Re-render table with sorted data
            displayResults({ count: sorted.length, results: sorted });
        }
        
        // Module Toggle (Hide/Unhide) Function
        function toggleModule(moduleId) {
            const content = document.getElementById(moduleId + 'Content');
            const button = event.target;
            
            if (content.classList.contains('collapsed')) {
                // Unhide
                content.classList.remove('collapsed');
                button.textContent = 'Hide';
            } else {
                // Hide
                content.classList.add('collapsed');
                button.textContent = 'Show';
            }
        }
        
        // Page ready
        console.log('Auction search ready');
        renderSavedSearches();
    </script>
</body>
</html>

