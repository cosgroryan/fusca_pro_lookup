{% extends "base.html" %}

{% block title %}Admin Dashboard - Fusca Pro Lookup{% endblock %}

{% block content %}
<!-- Password Prompt Modal -->
<div id="passwordModal" style="display: {% if require_auth %}block{% else %}none{% endif %}; position: fixed; z-index: 10000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.7);">
    <div style="background-color: white; margin: 15% auto; padding: 30px; border-radius: 8px; width: 90%; max-width: 400px; box-shadow: 0 4px 6px rgba(0,0,0,0.3);">
        <h2 style="color: #153D33; margin-top: 0; margin-bottom: 20px;">Admin Access Required</h2>
        <p style="color: #666; margin-bottom: 20px;">Please enter the password to access the admin dashboard:</p>
        <input type="password" id="adminPassword" placeholder="Enter password" style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px; margin-bottom: 15px; box-sizing: border-box;" autofocus>
        <div id="passwordError" style="color: #d32f2f; font-size: 12px; margin-bottom: 15px; display: none;"></div>
        <button onclick="submitPassword()" style="width: 100%; padding: 12px; background: #3D7F4B; color: white; border: none; border-radius: 4px; font-size: 14px; font-weight: 600; cursor: pointer;">Submit</button>
    </div>
</div>

<style>
    .event-item {
        cursor: pointer;
        transition: background-color 0.2s;
    }
    .event-item:hover {
        background-color: #f5f5f5 !important;
    }
    .event-detail-modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0,0,0,0.5);
    }
    .event-detail-content {
        background-color: white;
        margin: 5% auto;
        padding: 20px;
        border-radius: 8px;
        width: 80%;
        max-width: 800px;
        max-height: 80vh;
        overflow-y: auto;
        box-shadow: 0 4px 6px rgba(0,0,0,0.3);
    }
    .event-detail-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        padding-bottom: 10px;
        border-bottom: 2px solid #153D33;
    }
    .event-detail-close {
        color: #aaa;
        font-size: 28px;
        font-weight: bold;
        cursor: pointer;
    }
    .event-detail-close:hover {
        color: #000;
    }
    .event-detail-body {
        font-family: 'Courier New', monospace;
        font-size: 12px;
        background: #f8f8f8;
        padding: 15px;
        border-radius: 4px;
        border: 1px solid #ddd;
        white-space: pre-wrap;
        word-wrap: break-word;
    }
    .raw-logs-container {
        background: #1e1e1e;
        color: #d4d4d4;
        border-radius: 4px;
        padding: 0;
        margin-top: 30px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .raw-logs-header {
        background: #252526;
        padding: 12px 20px;
        border-bottom: 1px solid #3e3e42;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    .raw-logs-content {
        font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
        font-size: 11px;
        line-height: 1.5;
        padding: 20px;
        max-height: 500px;
        overflow-y: auto;
        white-space: pre;
        color: #d4d4d4;
    }
    .raw-logs-content::-webkit-scrollbar {
        width: 10px;
    }
    .raw-logs-content::-webkit-scrollbar-track {
        background: #1e1e1e;
    }
    .raw-logs-content::-webkit-scrollbar-thumb {
        background: #424242;
        border-radius: 5px;
    }
    .raw-logs-content::-webkit-scrollbar-thumb:hover {
        background: #4e4e4e;
    }
</style>

<div class="container" style="max-width: 1400px; margin: 20px auto; padding: 20px;">
    <h1 style="color: #153D33; margin-bottom: 30px; font-size: 28px;">Admin Dashboard</h1>
    
    <div style="display: flex; gap: 20px; margin-bottom: 30px; align-items: center; flex-wrap: wrap;">
        <button id="refresh-btn" style="padding: 10px 20px; background: #153D33; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 14px;">
            Refresh Data
        </button>
        <button id="clear-logs-btn" style="padding: 10px 20px; background: #D32F2F; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 14px; font-weight: 600;">
            Clear Logs (Archive)
        </button>
        <span id="last-updated" style="color: #666; font-size: 12px;"></span>
    </div>
    
    <!-- Summary Cards -->
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px;">
        <div class="stat-card" style="background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
            <div style="font-size: 32px; font-weight: bold; color: #153D33;" id="total-searches">0</div>
            <div style="color: #666; margin-top: 5px;">Total Searches</div>
        </div>
        <div class="stat-card" style="background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
            <div style="font-size: 32px; font-weight: bold; color: #1976D2;" id="last-24h">0</div>
            <div style="color: #666; margin-top: 5px;">Last 24 Hours</div>
        </div>
        <div class="stat-card" style="background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
            <div style="font-size: 32px; font-weight: bold; color: #388E3C;" id="last-7d">0</div>
            <div style="color: #666; margin-top: 5px;">Last 7 Days</div>
        </div>
        <div class="stat-card" style="background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
            <div style="font-size: 32px; font-weight: bold; color: #D32F2F;" id="error-count">0</div>
            <div style="color: #666; margin-top: 5px;">Errors</div>
        </div>
    </div>
    
    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 30px;">
        <!-- Searches by Tool -->
        <div style="background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
            <h2 style="color: #153D33; margin-bottom: 15px; font-size: 18px;">Searches by Tool</h2>
            <div id="by-tool" style="min-height: 200px;"></div>
        </div>
        
        <!-- Searches by Endpoint -->
        <div style="background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
            <h2 style="color: #153D33; margin-bottom: 15px; font-size: 18px;">Searches by Endpoint</h2>
            <div id="by-endpoint" style="min-height: 200px;"></div>
        </div>
    </div>
    
    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 30px;">
        <!-- Top Searched Wool Types -->
        <div style="background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
            <h2 style="color: #153D33; margin-bottom: 15px; font-size: 18px;">Top Searched Wool Types</h2>
            <div id="top-searches" style="min-height: 200px;"></div>
        </div>
        
        <!-- Recent Searches -->
        <div style="background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
            <h2 style="color: #153D33; margin-bottom: 15px; font-size: 18px;">Recent Searches <span style="font-size: 12px; font-weight: normal; color: #666;">(Click to view details)</span></h2>
            <div id="recent-searches" style="max-height: 400px; overflow-y: auto;"></div>
        </div>
    </div>
    
    <!-- Errors Section -->
    <div style="background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); margin-bottom: 30px;">
        <h2 style="color: #D32F2F; margin-bottom: 15px; font-size: 18px;">Recent Errors <span style="font-size: 12px; font-weight: normal; color: #666;">(Click to view details)</span></h2>
        <div id="errors" style="max-height: 300px; overflow-y: auto;"></div>
    </div>
    
    <!-- Raw Logs Section -->
    <div class="raw-logs-container">
        <div class="raw-logs-header">
            <h2 style="color: #d4d4d4; margin: 0; font-size: 16px;">Raw Logs <span id="log-stats" style="font-size: 12px; color: #858585;"></span></h2>
            <button id="refresh-logs-btn" style="padding: 6px 12px; background: #0e639c; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 11px;">Refresh Logs</button>
        </div>
        <div class="raw-logs-content" id="raw-logs-content">Loading logs...</div>
    </div>
</div>

<!-- Event Detail Modal -->
<div id="event-detail-modal" class="event-detail-modal">
    <div class="event-detail-content">
        <div class="event-detail-header">
            <h3 style="color: #153D33; margin: 0;">Event Details</h3>
            <span class="event-detail-close" onclick="closeEventDetail()">&times;</span>
        </div>
        <div class="event-detail-body" id="event-detail-body"></div>
    </div>
</div>

<script>
let analyticsData = null;

async function loadAnalytics() {
    try {
        const response = await fetch('/api/admin/analytics');
        analyticsData = await response.json();
        updateDashboard();
        document.getElementById('last-updated').textContent = `Last updated: ${new Date().toLocaleTimeString()}`;
    } catch (error) {
        console.error('Error loading analytics:', error);
        alert('Error loading analytics data');
    }
}

async function loadRawLogs() {
    try {
        const response = await fetch('/api/admin/raw-logs');
        const data = await response.json();
        
        if (data.error) {
            document.getElementById('raw-logs-content').textContent = 'Error loading logs: ' + data.error;
            return;
        }
        
        document.getElementById('raw-logs-content').textContent = data.logs;
        document.getElementById('log-stats').textContent = `(${data.showing_lines.toLocaleString()} of ${data.line_count.toLocaleString()} lines)`;
    } catch (error) {
        console.error('Error loading raw logs:', error);
        document.getElementById('raw-logs-content').textContent = 'Error loading logs: ' + error.message;
    }
}

function showEventDetail(event) {
    const modal = document.getElementById('event-detail-modal');
    const body = document.getElementById('event-detail-body');
    
    // Format the event data as JSON
    const formatted = JSON.stringify(event, null, 2);
    body.textContent = formatted;
    
    modal.style.display = 'block';
}

function closeEventDetail() {
    document.getElementById('event-detail-modal').style.display = 'none';
}

// Close modal when clicking outside
window.onclick = function(event) {
    const modal = document.getElementById('event-detail-modal');
    if (event.target === modal) {
        closeEventDetail();
    }
}

function updateDashboard() {
    if (!analyticsData) return;
    
    // Update summary cards
    document.getElementById('total-searches').textContent = analyticsData.total_searches.toLocaleString();
    document.getElementById('last-24h').textContent = analyticsData.time_stats.last_24h.toLocaleString();
    document.getElementById('last-7d').textContent = analyticsData.time_stats.last_7d.toLocaleString();
    document.getElementById('error-count').textContent = analyticsData.errors.length.toLocaleString();
    
    // Update by tool
    const byToolDiv = document.getElementById('by-tool');
    byToolDiv.innerHTML = '';
    const toolEntries = Object.entries(analyticsData.by_tool).sort((a, b) => b[1] - a[1]);
    toolEntries.forEach(([tool, count]) => {
        const div = document.createElement('div');
        div.style.cssText = 'display: flex; justify-content: space-between; padding: 10px; border-bottom: 1px solid #eee;';
        div.innerHTML = `
            <span style="font-weight: 500;">${tool}</span>
            <span style="color: #153D33; font-weight: bold;">${count.toLocaleString()}</span>
        `;
        byToolDiv.appendChild(div);
    });
    
    // Update by endpoint
    const byEndpointDiv = document.getElementById('by-endpoint');
    byEndpointDiv.innerHTML = '';
    const endpointEntries = Object.entries(analyticsData.by_endpoint).sort((a, b) => b[1] - a[1]);
    endpointEntries.forEach(([endpoint, count]) => {
        const div = document.createElement('div');
        div.style.cssText = 'display: flex; justify-content: space-between; padding: 10px; border-bottom: 1px solid #eee;';
        div.innerHTML = `
            <span style="font-weight: 500; font-size: 11px;">${endpoint}</span>
            <span style="color: #153D33; font-weight: bold;">${count.toLocaleString()}</span>
        `;
        byEndpointDiv.appendChild(div);
    });
    
    // Update top searches
    const topSearchesDiv = document.getElementById('top-searches');
    topSearchesDiv.innerHTML = '';
    analyticsData.top_searches.forEach((item, idx) => {
        const div = document.createElement('div');
        div.style.cssText = 'display: flex; justify-content: space-between; padding: 10px; border-bottom: 1px solid #eee;';
        div.innerHTML = `
            <span style="font-weight: 500;">${idx + 1}. ${item.wool_type || 'N/A'}</span>
            <span style="color: #153D33; font-weight: bold;">${item.count.toLocaleString()}</span>
        `;
        topSearchesDiv.appendChild(div);
    });
    
    // Update recent searches (clickable)
    const recentSearchesDiv = document.getElementById('recent-searches');
    recentSearchesDiv.innerHTML = '';
    analyticsData.recent_searches.forEach((activity, index) => {
        const div = document.createElement('div');
        div.className = 'event-item';
        div.style.cssText = 'padding: 10px; border-bottom: 1px solid #eee; font-size: 11px;';
        div.onclick = () => showEventDetail(activity);
        
        const tool = activity.tool || 'Unknown';
        const endpoint = activity.endpoint || 'Unknown';
        const timestamp = activity.timestamp || 'Unknown';
        const woolType = activity.data?.wool_type || 'N/A';
        const resultCount = activity.result_count !== undefined ? activity.result_count : 'N/A';
        
        div.innerHTML = `
            <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                <span style="font-weight: 500; color: #153D33;">${tool}</span>
                <span style="color: #666;">${timestamp}</span>
            </div>
            <div style="color: #666; font-size: 10px;">
                ${endpoint} ${woolType !== 'N/A' ? `• ${woolType}` : ''} ${resultCount !== 'N/A' ? `• ${resultCount} results` : ''}
            </div>
        `;
        recentSearchesDiv.appendChild(div);
    });
    
    // Update errors (clickable)
    const errorsDiv = document.getElementById('errors');
    errorsDiv.innerHTML = '';
    if (analyticsData.errors.length === 0) {
        errorsDiv.innerHTML = '<div style="padding: 20px; text-align: center; color: #666;">No errors found</div>';
    } else {
        analyticsData.errors.forEach(error => {
            const div = document.createElement('div');
            div.className = 'event-item';
            div.style.cssText = 'padding: 10px; border-bottom: 1px solid #eee; font-size: 11px;';
            div.onclick = () => showEventDetail(error);
            
            div.innerHTML = `
                <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                    <span style="font-weight: 500; color: #D32F2F;">${error.endpoint || 'Unknown'}</span>
                    <span style="color: #666;">${error.timestamp || 'Unknown'}</span>
                </div>
                <div style="color: #666; font-size: 10px;">
                    ${error.error || 'Unknown error'}
                </div>
            `;
            errorsDiv.appendChild(div);
        });
    }
}

async function clearLogs() {
    if (!confirm('Are you sure you want to archive and clear the logs? The current log file will be saved with a timestamp.')) {
        return;
    }
    
    try {
        const response = await fetch('/api/admin/clear-logs', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        });
        
        const data = await response.json();
        
        if (data.error) {
            alert('Error clearing logs: ' + data.error);
            return;
        }
        
        alert(`Logs archived successfully!\nArchived to: ${data.archive_file}\n\nLogs have been cleared.`);
        
        // Refresh both analytics and raw logs
        loadAnalytics();
        loadRawLogs();
        
    } catch (error) {
        console.error('Error clearing logs:', error);
        alert('Error clearing logs: ' + error.message);
    }
}

// Event listeners
document.getElementById('refresh-btn').addEventListener('click', () => {
    loadAnalytics();
    loadRawLogs();
});
document.getElementById('refresh-logs-btn').addEventListener('click', loadRawLogs);
document.getElementById('clear-logs-btn').addEventListener('click', clearLogs);

// Load on page load
document.addEventListener('DOMContentLoaded', function() {
    {% if require_auth %}
    // Don't load analytics if not authenticated
    return;
    {% else %}
    loadAnalytics();
    loadRawLogs();
    // Auto-refresh every 30 seconds
    setInterval(() => {
        loadAnalytics();
        loadRawLogs();
    }, 30000);
    {% endif %}
});

// Password authentication
{% if require_auth %}
function submitPassword() {
    const password = document.getElementById('adminPassword').value;
    const errorDiv = document.getElementById('passwordError');
    
    if (!password) {
        errorDiv.textContent = 'Please enter a password';
        errorDiv.style.display = 'block';
        return;
    }
    
    // Send password to server
    fetch('/api/admin/authenticate', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({ password: password })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Hide modal and reload page to show dashboard
            document.getElementById('passwordModal').style.display = 'none';
            window.location.reload();
        } else {
            errorDiv.textContent = data.error || 'Incorrect password';
            errorDiv.style.display = 'block';
            document.getElementById('adminPassword').value = '';
            document.getElementById('adminPassword').focus();
        }
    })
    .catch(error => {
        errorDiv.textContent = 'Error authenticating. Please try again.';
        errorDiv.style.display = 'block';
    });
}

// Allow Enter key to submit password
document.addEventListener('DOMContentLoaded', function() {
    const passwordInput = document.getElementById('adminPassword');
    if (passwordInput) {
        passwordInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                submitPassword();
            }
        });
    }
});
{% endif %}
</script>
{% endblock %}
