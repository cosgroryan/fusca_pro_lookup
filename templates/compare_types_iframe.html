{% extends "base.html" %}

{% set hide_nav = True %}

{% block title %}Compare Types - Fusca Pro Lookup{% endblock %}

{% block styles %}
<style>
    .help-icon {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: 16px;
        height: 16px;
        border-radius: 50%;
        background: #9C4DB5;
        color: white;
        font-size: 11px;
        font-weight: bold;
        cursor: help;
        margin-left: 6px;
        position: relative;
        vertical-align: middle;
        opacity: 0.5;
        transition: opacity 0.2s;
    }
    
    .help-icon:hover {
        background: #7B1FA2;
        opacity: 1;
    }
    
    .tooltip {
        position: absolute;
        background: #f5f0e8;
        color: #333;
        padding: 12px;
        border-radius: 6px;
        font-size: 12px;
        line-height: 1.6;
        width: 360px;
        max-width: 90vw;
        left: 24px;
        top: 100%;
        margin-top: 8px;
        z-index: 1000;
        box-shadow: 0 4px 12px rgba(0,0,0,0.25);
        border: 1px solid #d4c5a9;
        display: none;
        font-weight: normal;
        pointer-events: none;
    }
    
    .help-icon:hover .tooltip,
    .tooltip:hover {
        display: block;
        pointer-events: auto;
    }
    
    .help-icon:hover .tooltip {
        pointer-events: auto;
    }
    
    .tooltip strong {
        color: #3D7F4B;
        display: block;
        margin-top: 10px;
        margin-bottom: 4px;
        font-weight: 600;
    }
    
    .tooltip strong:first-child {
        margin-top: 0;
    }
    
    .tooltip code {
        background: rgba(61, 127, 75, 0.1);
        padding: 2px 6px;
        border-radius: 3px;
        font-family: 'Courier New', monospace;
        font-size: 11px;
        color: #153D33;
        border: 1px solid rgba(61, 127, 75, 0.2);
    }
    
    /* Mobile tooltip fix */
    @media (max-width: 768px) {
        .help-icon {
            width: 14px;
            height: 14px;
            font-size: 10px;
        }
        
        .tooltip {
            position: fixed;
            left: 10px !important;
            right: 10px !important;
            bottom: auto !important;
            top: 50% !important;
            transform: translateY(-50%);
            width: auto !important;
            max-width: none;
            font-size: 11px;
            padding: 10px;
        }
        
        .tooltip code {
            font-size: 10px;
        }
    }
    
    .simple-save-btn {
        background: transparent !important;
        background-color: transparent !important;
        border: none;
        color: #666;
        font-size: 12px;
        font-weight: 600;
        text-transform: uppercase;
        cursor: pointer;
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 0;
        text-decoration: none;
        transition: color 0.2s ease, text-decoration 0.2s ease;
    }
    
    .simple-save-btn img {
        width: 14px;
        height: 14px;
        opacity: 0.7;
        filter: brightness(0) saturate(100%) invert(50%) sepia(0%) saturate(0%) hue-rotate(0deg) brightness(1) contrast(1);
        transition: filter 0.2s ease, opacity 0.2s ease;
    }
    
    .simple-save-btn:hover,
    .simple-save-btn:focus,
    .simple-save-btn:active {
        background: transparent !important;
        background-color: transparent !important;
        border: none !important;
        color: #3D7F4B;
        text-decoration: underline;
    }
    
    .simple-save-btn:hover img {
        filter: brightness(0) saturate(100%) invert(38%) sepia(25%) saturate(2000%) hue-rotate(100deg) brightness(0.85) contrast(1);
        opacity: 1;
    }
    
    .saved-searches-section {
        background: #e8f5e9;
        padding: 15px;
        border-radius: 4px;
        margin-bottom: 20px;
    }
    
    .saved-search-item {
        display: inline-block;
        background: white;
        border: 1px solid #3D7F4B;
        border-radius: 4px;
        padding: 6px 10px;
        margin: 4px;
        cursor: pointer;
        transition: all 0.3s;
        font-size: 12px;
    }
    
    .saved-search-item:hover {
        background: #3D7F4B;
        color: white;
    }
    
    .saved-search-item .delete-btn {
        margin-left: 10px;
        color: #dc3545;
        font-weight: bold;
        cursor: pointer;
    }
    
    .saved-search-item:hover .delete-btn {
        color: white;
    }
</style>
{% endblock %}

{% block content %}
<!-- Saved Searches -->
<div class="saved-searches-section" id="savedSearchesSection" style="display: none;">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
        <h3 style="margin: 0; color: #153D33; font-size: 13px;">Saved Comparisons</h3>
        <button onclick="exportSavedSearches()" class="simple-save-btn" style="width: fit-content;">
            <img src="{{ url_for('static', filename='images/export-2-svgrepo-com.svg') }}" alt="Export" style="width: 14px; height: 14px;">
            EXPORT SAVES
        </button>
    </div>
    <div id="savedSearchesList"></div>
</div>

<!-- Compare Section -->
<div class="search-section" style="background: #e8f5e9; border: 2px solid #3D7F4B;">
    <h2 style="margin-bottom: 12px; color: #153D33; font-size: 14px;">
        Compare Wool Types
        <span class="help-icon">
            ?
            <div class="tooltip">
                <strong>How it works:</strong>
                Compare multiple wool types side-by-side to see price trends over time.
                
                <strong>Basic Syntax:</strong>
                Enter wool types separated by commas<br>
                <code>F2N, F3D, C3G</code>
                
                <strong>Examples:</strong>
                <code>F2N, F3D</code> - Compare 2 types<br>
                <code>C3G, C4G, F2D</code> - Compare 3 types
                
                <strong>Tip:</strong>
                For advanced features like weighted averages and grouped types, use the "Advanced Blends" tool.
            </div>
        </span>
    </h2>
    
    <div class="search-group">
        <label for="compareTypes">Enter wool types to compare (comma-separated, max 5)</label>
        <div class="search-bar">
            <input type="text" id="compareTypes" placeholder="e.g. F2N, F3D, C3G">
            <button onclick="compareWoolTypes()" id="compareBtn">Compare</button>
            <button onclick="resetFilters()" style="background: white; color: #3D7F4B; border: 1px solid #3D7F4B;">Reset</button>
            <button onclick="saveCurrentComparison()" class="simple-save-btn" style="width: fit-content;">
                <img src="{{ url_for('static', filename='images/save-svgrepo-com.svg') }}" alt="Save" style="width: 14px; height: 14px;">
                SAVE
            </button>
        </div>
    </div>
    
    <!-- Date Range Buttons -->
    <div class="search-group">
        <label>Quick Date Range:</label>
        <div class="date-range-buttons">
            <button class="date-range-btn" onclick="setDateRange('6m')">6 Months</button>
            <button class="date-range-btn" onclick="setDateRange('1y')">1 Year</button>
            <button class="date-range-btn" onclick="setDateRange('3y')">3 Years</button>
            <button class="date-range-btn" onclick="setDateRange('all')">All Time</button>
            <button class="date-range-btn" onclick="toggleCustomDateRange()">Custom</button>
            <div class="date-range-custom" id="customDateRange">
                <label style="font-size: 12px; margin: 0;">From:</label>
                <input type="date" id="customDateFrom" />
                <label style="font-size: 12px; margin: 0;">To:</label>
                <input type="date" id="customDateTo" />
                <button class="date-range-btn" style="background: #3D7F4B;" onclick="applyCustomDateRange()">Apply</button>
            </div>
        </div>
    </div>
    
    <!-- Column Filters -->
    <div class="filters-container">
        <div class="filters-header">
            <h3>Additional Filters</h3>
            <button class="add-filter-btn" onclick="addFilter()">+ Add Filter</button>
        </div>
        <div id="filtersList"></div>
    </div>
</div>

<!-- Comparison Chart -->
<div class="chart-section" id="compareChartSection" style="display: none;">
    <div class="module-header">
        <h2 style="color: #153D33; font-size: 14px;">Price Comparison (Volume-Weighted)</h2>
        <button class="hide-btn content-visible" onclick="toggleModule('compareChart')" aria-label="Hide"><img src="{{ url_for('static', filename='images/eye-off-svgrepo-com.svg') }}" alt="Hide"></button>
    </div>
    <div id="compareChartContent" class="module-content">
        <div class="chart-container">
            <canvas id="compareChart"></canvas>
        </div>
    </div>
</div>

<div id="errorMsg" class="error" style="display: none;"></div>
<div id="loading" class="loading" style="display: none;">Loading...</div>

{% endblock %}

{% block scripts %}
<script>
    let compareChart = null;
    let filterCount = 0;
    let currentDateFilter = null;
    let isComparing = false;
    
    function setDateRange(range) {
        if (isPostOperationInProgress()) {
            console.log('Operation in progress, cannot change date range');
            return;
        }
        
        document.querySelectorAll('.date-range-btn').forEach(btn => btn.classList.remove('active'));
        event.target.classList.add('active');
        document.getElementById('customDateRange').classList.remove('show');
        
        if (range === 'all') {
            currentDateFilter = null;
        } else {
            currentDateFilter = getDateRangeFilter(range);
        }
        
        // Auto-trigger comparison if types are entered
        const input = document.getElementById('compareTypes').value.trim();
        if (input) {
            compareWoolTypes();
        }
    }
    
    function toggleCustomDateRange() {
        const customSection = document.getElementById('customDateRange');
        document.querySelectorAll('.date-range-btn').forEach(btn => btn.classList.remove('active'));
        
        if (!customSection.classList.contains('show')) {
            customSection.classList.add('show');
            event.target.classList.add('active');
        } else {
            customSection.classList.remove('show');
        }
    }
    
    function applyCustomDateRange() {
        if (isPostOperationInProgress()) {
            console.log('Operation in progress, cannot change date range');
            return;
        }
        
        const fromDate = document.getElementById('customDateFrom').value;
        const toDate = document.getElementById('customDateTo').value;
        
        if (!fromDate || !toDate) {
            alert('Please select both dates');
            return;
        }
        
        currentDateFilter = {
            column: 'sale_date',
            operator: 'between',
            value: fromDate,
            value2: toDate
        };
        
        // Auto-trigger comparison if types are entered
        const input = document.getElementById('compareTypes').value.trim();
        if (input) {
            compareWoolTypes();
        }
    }
    
    function addFilter() {
        const filterId = `filter_${filterCount++}`;
        const filtersList = document.getElementById('filtersList');
        
        const filterDiv = document.createElement('div');
        filterDiv.className = 'filter-row';
        filterDiv.id = filterId;
        
        filterDiv.innerHTML = `
            <select class="filter-column" onchange="updateFilterOperators('${filterId}')">
                <option value="">Select Column</option>
                ${columns.filter(c => c.name !== 'sale_date').map(col => 
                    `<option value="${col.name}" data-type="${col.type}">${col.label}</option>`
                ).join('')}
            </select>
            <select class="filter-operator">
                <option value="">Select Operator</option>
            </select>
            <input type="text" class="filter-value" placeholder="Value">
            <input type="text" class="filter-value2" placeholder="Value 2" style="display:none;">
            <button class="remove-filter" onclick="removeFilter('${filterId}')">Remove</button>
        `;
        
        filtersList.appendChild(filterDiv);
    }
    
    function updateFilterOperators(filterId) {
        const filterDiv = document.getElementById(filterId);
        const columnSelect = filterDiv.querySelector('.filter-column');
        const operatorSelect = filterDiv.querySelector('.filter-operator');
        const valueInput = filterDiv.querySelector('.filter-value');
        const value2Input = filterDiv.querySelector('.filter-value2');
        
        const selectedOption = columnSelect.options[columnSelect.selectedIndex];
        const columnType = selectedOption.getAttribute('data-type');
        
        operatorSelect.innerHTML = '<option value="">Select Operator</option>';
        value2Input.style.display = 'none';
        
        if (columnType && operators[columnType]) {
            operators[columnType].forEach(op => {
                const option = document.createElement('option');
                option.value = op.value;
                option.textContent = op.label;
                operatorSelect.appendChild(option);
            });
        }
        
        if (columnType === 'number') {
            valueInput.type = 'number';
            valueInput.step = '0.1';
            value2Input.type = 'number';
            value2Input.step = '0.1';
        } else if (columnType === 'date') {
            valueInput.type = 'date';
            value2Input.type = 'date';
        } else {
            valueInput.type = 'text';
            value2Input.type = 'text';
        }
        
        operatorSelect.onchange = function() {
            value2Input.style.display = this.value === 'between' ? 'block' : 'none';
        };
    }
    
    function removeFilter(filterId) {
        document.getElementById(filterId).remove();
    }
    
    function getFilters() {
        const filters = [];
        
        // Add date filter if set
        if (currentDateFilter) {
            filters.push(currentDateFilter);
        }
        
        // Add user filters
        const filterRows = document.querySelectorAll('.filter-row');
        filterRows.forEach(row => {
            const column = row.querySelector('.filter-column').value;
            const operator = row.querySelector('.filter-operator').value;
            const value = row.querySelector('.filter-value').value;
            const value2 = row.querySelector('.filter-value2').value;
            
            if (column && operator && value) {
                filters.push({
                    column,
                    operator,
                    value,
                    value2: operator === 'between' ? value2 : null
                });
            }
        });
        
        return filters;
    }
    
    async function compareWoolTypes() {
        // Prevent concurrent comparisons
        if (isComparing || isPostOperationInProgress()) {
            console.log('Comparison already in progress, skipping...');
            return;
        }
        
        const input = document.getElementById('compareTypes').value.trim();
        
        if (!input) {
            alert('Please enter wool types to compare');
            return;
        }
        
        const woolTypes = input.split(',').map(t => t.trim()).filter(t => t);
        
        if (woolTypes.length === 0) {
            alert('Please enter at least one wool type');
            return;
        }
        
        if (woolTypes.length > 5) {
            alert('Maximum 5 wool types for comparison');
            return;
        }
        
        if (!currentDateFilter) {
            const proceed = confirm(
                '⚠️ No date filter selected!\n\n' +
                'This query will process all historical data and may take 10-30 seconds.\n\n' +
                'Continue anyway?'
            );
            if (!proceed) return;
        }
        
        isComparing = true;
        disablePostButtons();
        document.getElementById('compareChartSection').style.display = 'none';
        document.getElementById('loading').style.display = 'block';
        
        try {
            const response = await fetch('/api/compare_chart', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    wool_types: woolTypes,
                    column_filters: getFilters()
                })
            });
            
            if (!response.ok) {
                throw new Error(`Server error: ${response.status}`);
            }
            
            const data = await response.json();
            
            if (data.error) {
                throw new Error(data.error);
            }
            
            displayCompareChart(data);
            
        } catch (error) {
            console.error('Compare error:', error);
            showError('Comparison failed: ' + error.message);
        } finally {
            document.getElementById('loading').style.display = 'none';
            isComparing = false;
            enablePostButtons();
        }
    }
    
    function displayCompareChart(data) {
        document.getElementById('compareChartSection').style.display = 'block';
        
        const ctx = document.getElementById('compareChart').getContext('2d');
        
        if (compareChart) {
            compareChart.destroy();
        }
        
        compareChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: data.labels,
                datasets: data.datasets
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                interaction: {
                    mode: 'index',
                    intersect: false
                },
                plugins: {
                    legend: { display: true, position: 'top' },
                    tooltip: {
                        mode: 'index',
                        intersect: false,
                        callbacks: {
                            label: function(context) {
                                return context.dataset.label + ': $' + context.parsed.y.toFixed(2);
                            }
                        }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        title: { display: true, text: 'Average Price ($)' },
                        ticks: { callback: function(value) { return '$' + value; } }
                    },
                    x: {
                        title: { display: true, text: 'Sale Date' },
                        ticks: { maxRotation: 45, minRotation: 45, maxTicksLimit: 20 }
                    }
                }
            }
        });
    }
    
    function resetFilters() {
        document.getElementById('compareTypes').value = '';
        document.getElementById('filtersList').innerHTML = '';
        filterCount = 0;
        currentDateFilter = null;
        
        document.querySelectorAll('.date-range-btn').forEach(btn => btn.classList.remove('active'));
        document.getElementById('customDateRange').classList.remove('show');
        
        document.getElementById('compareChartSection').style.display = 'none';
        document.getElementById('errorMsg').style.display = 'none';
    }
    
    function showError(message) {
        const errorDiv = document.getElementById('errorMsg');
        errorDiv.textContent = message;
        errorDiv.style.display = 'block';
    }
    
    // Saved searches functionality
    async function saveCurrentComparison() {
        const input = document.getElementById('compareTypes').value.trim();
        
        if (!input) {
            alert('Please enter wool types to compare first');
            return;
        }
        
        const name = prompt('Enter a name for this comparison:');
        if (!name) return;
        
        const woolTypes = input.split(',').map(t => t.trim()).filter(t => t);
        const filters = getFilters();
        
        let savedSearches = JSON.parse(localStorage.getItem('fusca_saved_searches') || '[]');
        
        savedSearches.push({
            id: Date.now(),
            name: name,
            wool_types: woolTypes,
            filters: filters,
            dateFilter: currentDateFilter,
            page: 'compare',
            type: 'compare',
            created: new Date().toISOString()
        });
        
        localStorage.setItem('fusca_saved_searches', JSON.stringify(savedSearches));
        
        try {
            await fetch('/api/log_saved_search', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ 
                    name: name, 
                    type: 'compare',
                    comparison_data: { wool_types: woolTypes, filters: filters, dateFilter: currentDateFilter }
                })
            });
        } catch (e) {
            console.warn('Failed to log saved comparison:', e);
        }
        
        renderSavedSearches();
        console.log('Comparison saved:', name);
    }
    
    function loadSavedSearch(searchId) {
        if (isPostOperationInProgress()) {
            console.log('Operation in progress, cannot load saved search');
            return;
        }
        
        const savedSearches = JSON.parse(localStorage.getItem('fusca_saved_searches') || '[]');
        const savedSearch = savedSearches.find(s => s.id === searchId);
        
        if (!savedSearch || (savedSearch.page !== 'compare' && savedSearch.type !== 'compare')) return;
        
        // Clear current filters
        document.getElementById('filtersList').innerHTML = '';
        filterCount = 0;
        currentDateFilter = savedSearch.dateFilter || null;
        
        // Set wool types
        if (savedSearch.wool_types && Array.isArray(savedSearch.wool_types)) {
            document.getElementById('compareTypes').value = savedSearch.wool_types.join(', ');
        }
        
        // Set date filter state
        if (currentDateFilter) {
            if (currentDateFilter.operator === 'between') {
                document.getElementById('customDateFrom').value = currentDateFilter.value;
                document.getElementById('customDateTo').value = currentDateFilter.value2;
            }
        }
        
        // Add filters
        if (savedSearch.filters && Array.isArray(savedSearch.filters)) {
            savedSearch.filters.forEach(filter => {
                if (filter.column !== 'sale_date') {
                    addFilter();
                    const lastFilter = document.getElementById('filtersList').lastElementChild;
                    lastFilter.querySelector('.filter-column').value = filter.column;
                    updateFilterOperators(lastFilter.id);
                    lastFilter.querySelector('.filter-operator').value = filter.operator;
                    lastFilter.querySelector('.filter-value').value = filter.value;
                    if (filter.value2) {
                        lastFilter.querySelector('.filter-value2').value = filter.value2;
                        lastFilter.querySelector('.filter-value2').style.display = 'block';
                    }
                }
            });
        }
        
        // Trigger comparison
        compareWoolTypes();
    }
    
    function deleteSavedSearch(searchId) {
        if (!confirm('Delete this saved comparison?')) return;
        
        let savedSearches = JSON.parse(localStorage.getItem('fusca_saved_searches') || '[]');
        savedSearches = savedSearches.filter(s => s.id !== searchId);
        localStorage.setItem('fusca_saved_searches', JSON.stringify(savedSearches));
        
        renderSavedSearches();
    }
    
    function renderSavedSearches() {
        const savedSearches = JSON.parse(localStorage.getItem('fusca_saved_searches') || '[]');
        const compareSearches = savedSearches.filter(s => s.page === 'compare' || s.type === 'compare');
        const container = document.getElementById('savedSearchesList');
        const section = document.getElementById('savedSearchesSection');
        
        if (compareSearches.length === 0) {
            section.style.display = 'none';
            return;
        }
        
        section.style.display = 'block';
        container.innerHTML = '';
        
        compareSearches.forEach(search => {
            const item = document.createElement('div');
            item.className = 'saved-search-item';
            item.innerHTML = `
                <span onclick="loadSavedSearch(${search.id})">${search.name}</span>
                <span class="delete-btn" onclick="event.stopPropagation(); deleteSavedSearch(${search.id})">✕</span>
            `;
            container.appendChild(item);
        });
    }
    
    console.log('Compare types ready');
    renderSavedSearches();
</script>
{% endblock %}
